---
title: "Prior specification"
format: 
  html:
    embed-resources: true
    toc: true
editor: source
code-fold: true
---

```{r}
#| include: false
library(flextable)
library(tidyverse)

set_theme(theme_minimal())
```

# Priors for $\beta$

For the average effect parameter $\beta$, we consider $L$-norm priors with density
$$
d_\beta(b) \propto \exp\left(- \phi\left| b - \mu \right|^L \right),
$$
where $\mu$ is the mean (and median and mode), $\phi$ is a precision parameter (i.e., inverse of scale), and $L$ is the norm. We consider two version of the priors, both with $\mu = 0$. As a potential default prior, we use $L = 2$ and $\phi = \frac{1}{2}$, which corresponds to a standard normal distribution. As a weaker prior, we use $L = 4$ and $\phi = \frac{1}{16}$, which produces a playtkurtic distribution that is very flat over the range $|\beta| < 0.8$ but becomes much sharper for $|\beta| > 2$. @fig-beta-priors depicts the densities of these prior distributions, with the default in red and the weaker prior in purple.

::: {.panel-tabset}

## Density

```{r}
#| label: fig-beta-priors
#| fig-cap: "Prior distributions on $\\beta$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

Lp_dist <- function(mu = 0, precision = 1, L = 2, ...) {
  Const <- gamma(1 / L) * 2 / (L * precision^(1 / L))
  f <- function(x) exp(-precision * abs(x - mu)^L) / Const
  g <- function(x) sapply(x, \(y) integrate(f, lower = -Inf, upper = y, ...)$value)
  
  return(list(pdf = f, cdf = g))
}


beta_default <- Lp_dist(mu = 0, precision = 1 / 2, L = 2)
beta_weak <- Lp_dist(mu = 0, precision = 1 / 16, L = 4)

x <- seq(-4, 4, length.out = 500)

beta_density_dat <-
  tibble(
    beta = x,
    default = beta_default$pdf(x),
    weak = beta_weak$pdf(x)
  ) 

ggplot(beta_density_dat) + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  geom_area(aes(beta, default), fill = "red", alpha = 0.5) + 
  geom_area(aes(beta, weak), fill = "purple", alpha = 0.5) + 
  scale_x_continuous(expand = expansion(0,0)) + 
  labs(
    x = expression(beta), 
    y = expression(p[beta](b))
  )

```

## Log-density

```{r}
#| label: fig-beta-priors-log
#| fig-cap: "Log of prior densities on $\\beta$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

beta_density_dat %>%
  mutate(
    across(c(default, weak), ~ log(.x) - max(log(.x)))
  ) %>%
  ggplot() + 
  geom_line(aes(beta, default), color = "red") + 
  geom_line(aes(beta, weak), color = "purple") + 
  scale_x_continuous(expand = expansion(0,0)) + 
  coord_cartesian(ylim = c(-10,0)) + 
  labs(
    x = expression(beta), 
    y = expression(ln(p[beta](b)))
  )

```

:::

To further interpret these priors, we can consider 1) the density at benchmark values of $\beta$ relative to the density at the center of the distribution and 2) the total prior probability of $|\beta| < b$ for various values of $b$. @tbl-beta reports these quantities for both the default and weaker priors. The columns labelled "Relative density" correspond to $d_\beta(b) / d_\beta(0)$; the columns labelled "Prior probability" correspond to $\text{Pr}(|\beta| < b)$.

```{r}
#| label: tbl-beta
#| tbl-cap: Relative density and total probability for benchmark values of $\\beta$

x_bench <- c(0.25, 0.5, 0.8, seq(1, 3, 0.5))


tibble(
  beta_b = x_bench,
  d_Default = beta_default$pdf(x_bench) / beta_default$pdf(0),
  d_Weaker = beta_weak$pdf(x_bench) / beta_weak$pdf(0),
  c_Default = 2 * (beta_default$cdf(x_bench) - 0.5),
  c_Weaker = 2 * (beta_weak$cdf(x_bench) - 0.5),
) %>%
  flextable() %>%
  separate_header() %>%
  labelizor(labels = c('beta' = "",'d' = "Relative density", 'c' = "Prior probability")) %>%
  colformat_double(j = 2:5, digits = 3)
  
```

# Priors for $\zeta$ (log of the selection parameter)

For the selection parameter $\zeta = \log(\lambda)$, we consider $L$-norm priors with density
$$
d_\zeta(z) \propto \exp\left(- \phi\left| z - \mu \right|^L \right),
$$
where $\mu$ is the mean (and median and mode), $\phi$ is a precision parameter (i.e., inverse of scale), and $L$ is the norm. We consider two version of the priors. As a potential default prior, we use $L = 2$, $\mu = \log(0.8)$, and $\phi = \frac{1}{2}$, which implies that $\zeta$ follows a normal distribution with mode of $\mu$ and a standard deviation of 1 (i.e., $\lambda$ follows a log-normal distribution). As a weaker prior, we use $L = 4$, $\mu = \log(0.5)$, and $\phi = \frac{1}{16}$, which produces a playtkurtic distribution that is very flat over the range $0.2 < \lambda < 1$ but becomes much sharper for $\lambda < 0.05$ or $\lambda > 5$. @fig-zeta-priors depicts the densities of these prior distributions, with the default in red and the weaker prior in purple.

::: {.panel-tabset}

## Density

```{r}
#| label: fig-zeta-priors
#| fig-cap: "Prior distributions on $\\zeta$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

z <- seq(log(0.01), log(16), length.out = 500)
lambda_bench <- c(0.01, 0.02, 0.05, 0.10, 0.20, 0.50, 0.8, 1, 1.5, 2, 4, 8, 16)
z_bench <- log(lambda_bench)

zeta_default <- Lp_dist(mu = log(0.8), precision = 1 / 2, L = 2)
zeta_weak <- Lp_dist(mu = log(0.5), precision = 1 / 16, L = 4)


zeta_density_dat <- 
  tibble(
    zeta = z,
    lambda = exp(z),
    default = zeta_default$pdf(z),
    weak = zeta_weak$pdf(z)
  )

ggplot(zeta_density_dat) + 
  geom_vline(xintercept = 1, linetype = "dashed") + 
  geom_area(aes(lambda, default), fill = "red", alpha = 0.5) + 
  geom_area(aes(lambda, weak), fill = "purple", alpha = 0.5) + 
  scale_x_continuous(
    transform = "log", 
    breaks = lambda_bench[c(1:6,8,10:13)],
    expand = expansion(0,0)
  ) + 
  labs(
    x = expression(lambda == exp(zeta)), 
    y = expression(p[zeta](z))
  )

```

## Log-density

```{r}
#| label: fig-zeta-priors-log
#| fig-cap: "Log of prior densities on $\\zeta$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

zeta_density_dat %>%
  mutate(
    across(c(default, weak), ~ log(.x) - max(log(.x)))
  ) %>%
  ggplot() + 
  geom_line(aes(lambda, default), color = "red") + 
  geom_line(aes(lambda, weak), color = "purple") + 
  scale_x_continuous(
    transform = "log", 
    breaks = lambda_bench[c(1:6,8,10:13)],
    expand = expansion(0,0)
  ) + 
  coord_cartesian(ylim = c(-10,0)) + 
  labs(
    x = expression(lambda == exp(zeta)), 
    y = expression(ln(p[zeta](z)))
  )

```

:::

To further interpret these priors, we can consider 1) the density at benchmark values of $\lambda$ relative to the density at $\lambda = 1$ (or $\zeta = 0$) and 2) the cumulative prior probability of $\lambda < l$ for various values of $l$. @tbl-zeta reports these quantities for both the default and weaker priors. The columns labelled "Relative density" correspond to $d_\zeta(l) / d_\zeta(1)$; the columns labelled "Cumulative probability" correspond to $\text{Pr}(\lambda < l)$.

```{r}
#| label: tbl-zeta
#| tbl-cap: Relative density and total probability for benchmark values of $\\lambda$

tibble(
  lambda_l = lambda_bench,
  zeta_z = z_bench,
  d_Default = zeta_default$pdf(z_bench) / zeta_default$pdf(0),
  d_Weaker = zeta_weak$pdf(z_bench) / zeta_weak$pdf(0),
  c_Default = zeta_default$cdf(z_bench),
  c_Weaker = zeta_weak$cdf(z_bench)
) %>%
  flextable() %>%
  separate_header() %>%
  labelizor(labels = c('lambda' = "",'zeta' = "",'d' = "Relative density", 'c' = "Cumulative probability")) %>%
  colformat_double(j = 2:6, digits = 3)
  
```

# Priors for $\gamma$ (log of the heterogeneity)

For the heterogeneity parameter $\tau$, we consider a $\Gamma$ prior with shape parameter $\alpha$ and rate parameter $\lambda$. This implies that $\gamma = \log(\tau^2)$ follows an exponential-gamma distribution, with density proportional to
$$
d_\gamma(g) \propto \exp\left(\alpha \times \frac{g}{2} - \lambda \times \exp\left(\frac{g}{2}\right) \right).
$$
We reparameterize this distribution in terms of its exponentiated mode, which occurs at $\exp(g / 2) = \psi = \alpha / \lambda$. Again, we consider two version of the priors. As a potential default prior, we use $\psi = 0.2$ and $\alpha = 2$, which implies that $\tau$ follows a $\Gamma(2, 5)$ distribution. As a weaker prior, we use $\psi = 0.2$ and $\alpha = 1$, which implies that $\tau$ follows an $\text{Exp}(1/5)$ distribution. @fig-zeta-priors depicts the densities of these prior distributions, with the default in red and the weaker prior in purple.

::: {.panel-tabset}

## Density

```{r}
#| label: fig-gamma-priors
#| fig-cap: "Prior distributions on $\\gamma$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

loggamma_dist <- function(mode, alpha, ...) {
  lambda <- alpha / mode
  f <- function(x) dgamma(exp(x / 2), shape = alpha + 1, rate = lambda)
  g <- function(x) pgamma(exp(x / 2), shape = alpha, rate = lambda)
  return(list(pdf = f, cdf = g))
}

g <- seq(log(0.01^2), log(1^2), length.out = 500)
tau_bench <- c(0.01, 0.05, seq(0.1, 0.4, 0.1), seq(0.6, 1, 0.2))
g_bench <- 2 * log(tau_bench)

gamma_default <- loggamma_dist(mode = 0.2, alpha = 2)
gamma_weak <- loggamma_dist(mode = 0.2, alpha = 1)


gamma_density_dat <- 
  tibble(
  gamma = g,
  tau = exp(g / 2),
  default = gamma_default$pdf(g),
  weak = gamma_weak$pdf(g),
) 

ggplot(gamma_density_dat) + 
  geom_area(aes(tau, default), fill = "red", alpha = 0.5) + 
  geom_area(aes(tau, weak), fill = "purple", alpha = 0.5) + 
  scale_x_continuous(
    transform = "log", 
    breaks = tau_bench,
    expand = expansion(0,0)
  ) + 
  labs(
    x = expression(tau), 
    y = expression(p(tau))
  )

```

## Log-density

```{r}
#| label: fig-gamma-priors-log
#| fig-cap: "Log of prior densities on $\\gamma$"
#| fig-width: 7
#| fig-height: 4
#| out-width: 100%

gamma_density_dat %>%
  mutate(
    across(c(default, weak), ~ log(.x) - max(log(.x)))
  ) %>%
  ggplot() + 
  geom_line(aes(tau, default), color = "red") + 
  geom_line(aes(tau, weak), color = "purple") + 
  scale_x_continuous(
    transform = "log", 
    breaks = tau_bench,
    expand = expansion(0,0)
  ) + 
  coord_cartesian(ylim = c(-10,0)) + 
  labs(
    x = expression(tau), 
    y = expression(ln(p[tau](t)))
  )
```

:::

To further interpret these priors, we can consider 1) the density at benchmark values of $\tau$ relative to the density at the mode $\psi$ and 2) the cumulative prior probability of $\tau < t$ for various values of $t$. @tbl-gamma reports these quantities for both the default and weaker priors. The columns labelled "Relative density" correspond to $d_\gamma(g) / d_\gamma\left(2\log(\psi)\right)$; the columns labelled "Cumulative probability" correspond to $\text{Pr}(\gamma < g)$.

```{r}
#| label: tbl-gamma
#| tbl-cap: Relative density and total probability for benchmark values of $\\tau$

tibble(
  tau_t = tau_bench,
  gamma_g = g_bench,
  d_Default = gamma_default$pdf(g_bench) / gamma_default$pdf(2 * log(0.2)),
  d_Weaker = gamma_weak$pdf(g_bench) / gamma_weak$pdf(2 * log(0.2)),
  c_Default = gamma_default$cdf(g_bench),
  c_Weaker = gamma_weak$cdf(g_bench)
) %>%
  flextable() %>%
  separate_header() %>%
  labelizor(labels = c('tau' = "",'gamma' = "",'d' = "Relative density", 'c' = "Cumulative probability")) %>%
  colformat_double(j = 2:6, digits = 3)
  
```

